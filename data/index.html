<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UK High Court - Judge Speed Analysis</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 20px; color: #222; }
    h1 { margin-bottom: 0.2em; }
    .meta { color: #666; margin-bottom: 1em; }
    .section { margin-top: 28px; }
    table.dataTable tbody tr:hover { background: #f5f8ff; }
    .card { padding:12px; border:1px solid #e3e3e3; border-radius:10px; background:#fafafa; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    code { background:#f2f2f2; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Judge Speed Analysis (EWHC: King's Bench)</h1>
  <div class="meta">Uses <code>cases_speed.json</code>, <code>judge_effects.json</code>, and <code>speed_results.json</code> produced by <code>v2.py</code>. Focuses on hearing->judgment turnaround with judge fixed effects.</div>

  <div class="grid">
    <div class="card" id="metrics-card">
      <div><strong>Model / F-test</strong></div>
      <div id="metrics-body">Loading...</div>
    </div>
    <div class="card" id="dispersion-card">
      <div><strong>Dispersion of judge effects</strong></div>
      <div id="dispersion-body">Loading...</div>
    </div>
    <div class="card" id="robust-card">
      <div><strong>Log-scale robustness</strong></div>
      <div id="robust-body">Loading...</div>
    </div>
    <div class="card" id="prep-card">
      <div><strong>Preprocessing</strong></div>
      <div id="prep-body">Loading...</div>
    </div>
    <div class="card">
      <div><strong>Data files</strong></div>
      <ul>
        <li>cases_speed.json</li>
        <li>judge_effects.json</li>
        <li>speed_results.json</li>
      </ul>
    </div>
  </div>

  <div class="section">
    <h2>Judge fixed effects (days relative to baseline)</h2>
    <table id="judges-table" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Judge</th>
          <th>Cases</th>
          <th>Effect (days)</th>
          <th>Mean turnaround</th>
          <th>Median turnaround</th>
          <th>Baseline?</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Cases with turnaround</h2>
    <table id="cases-table" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Case ID</th>
          <th>Title</th>
          <th>Judge</th>
          <th>Turnaround (days)</th>
          <th>Hearing start</th>
          <th>Judgment date</th>
          <th>Judgment year</th>
          <th>Area of law</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Plots</h2>
    <div id="plots-grid" class="grid"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    const BASE = './';

    function fmtNum(val, digits = 2) {
      return (val === null || val === undefined || Number.isNaN(val)) ? '' : Number(val).toFixed(digits);
    }

    async function loadAll() {
      const [cases, effects, results] = await Promise.all([
        fetch(BASE + 'cases_speed.json').then(r => r.json()),
        fetch(BASE + 'judge_effects.json').then(r => r.json()),
        fetch(BASE + 'speed_results.json').then(r => r.json())
      ]);

      // Summary cards
      const f = results.f_test || {};
      const t = results.turnaround_summary || {};
      const metricsHtml = `
        <div><strong>Cases:</strong> ${results.n_cases ?? '–'} | <strong>Judges:</strong> ${results.n_judges ?? '–'}</div>
        <div><strong>Mean turnaround:</strong> ${fmtNum(t.mean, 1)} days (median ${fmtNum(t.median, 1)})</div>
        <div><strong>F-stat (judge FE):</strong> ${fmtNum(f.stat, 3)} | p=${fmtNum(f.p_value, 4)}</div>
        <div><strong>R² / adj R²:</strong> ${fmtNum(results.r2, 3)} / ${fmtNum(results.adj_r2, 3)}</div>
        <div><strong>Controls:</strong> ${Array.isArray(results.controls) ? results.controls.join(', ') : '–'}</div>
      `;
      document.getElementById('metrics-body').innerHTML = metricsHtml;

      const d = results.dispersion || {};
      const dispersionHtml = `
        <div><strong>Std dev (γ):</strong> ${fmtNum(d.std, 2)} days</div>
        <div><strong>P10 → P90:</strong> ${fmtNum(d.p10, 1)} → ${fmtNum(d.p90, 1)} (span ${fmtNum((d.p90 ?? 0) - (d.p10 ?? 0), 1)})</div>
        <div><strong>IQR:</strong> ${fmtNum(d.iqr, 1)} days</div>
        <div><strong>Range:</strong> ${fmtNum(d.range, 1)} days</div>
      `;
      document.getElementById('dispersion-body').innerHTML = dispersionHtml;

      const logm = results.log_model || {};
      const lf = logm.f_test || {};
      const robustHtml = logm && lf && lf.stat !== undefined ? `
        <div><strong>F-stat (log scale):</strong> ${fmtNum(lf.stat, 3)} | p=${fmtNum(lf.p_value, 4)}</div>
        <div><strong>R² / adj R²:</strong> ${fmtNum(logm.r2, 3)} / ${fmtNum(logm.adj_r2, 3)}</div>
      ` : 'No log model available.';
      document.getElementById('robust-body').innerHTML = robustHtml;

      const wins = results.winsor || {};
      const trim = results.trim || {};
      const prepHtml = `
        <div><strong>Trim:</strong> ${trim.low !== undefined ? `${fmtNum(trim.low,1)}–${fmtNum(trim.high,1)} (dropped ${trim.dropped ?? 0})` : 'none'}</div>
        <div><strong>Winsor:</strong> ${wins.low !== undefined ? `${fmtNum(wins.low,1)}–${fmtNum(wins.high,1)}` : 'none'}</div>
        <div><strong>Controls:</strong> ${Array.isArray(results.controls) ? results.controls.join(', ') : '–'}</div>
      `;
      document.getElementById('prep-body').innerHTML = prepHtml;

      // Judges table
      const judgeRows = (effects || []).map(e => ({
        judge: e.judge,
        cases: e.n_cases,
        effect: fmtNum(e.effect_days, 2),
        mean: fmtNum(e.mean_turnaround, 1),
        median: fmtNum(e.median_turnaround, 1),
        baseline: e.is_baseline ? 'Yes' : ''
      }));

      $('#judges-table').DataTable({
        data: judgeRows,
        columns: [
          { data: 'judge', render: $.fn.dataTable.render.text() },
          { data: 'cases' },
          { data: 'effect' },
          { data: 'mean' },
          { data: 'median' },
          { data: 'baseline' }
        ],
        pageLength: 25,
        order: [[2, 'asc']],
        dom: 'lrtip'
      });

      const caseRows = (cases || []).map(c => ({
        case_id: c.case_id || '',
        title: c.title || '',
        judge: c.judge || '',
        turnaround: c.turnaround_days ?? '',
        hearing_start: c.hearing_start || '',
        judgment_date: c.judgment_date || '',
        judgment_year: c.judgment_year ?? '',
        area: c.area_of_law || ''
      }));

      $('#cases-table').DataTable({
        data: caseRows,
        columns: [
          { data: 'case_id' },
          { data: 'title', render: $.fn.dataTable.render.text() },
          { data: 'judge' },
          { data: 'turnaround' },
          { data: 'hearing_start' },
          { data: 'judgment_date' },
          { data: 'judgment_year' },
          { data: 'area', render: $.fn.dataTable.render.text() }
        ],
        pageLength: 25,
        order: [[3, 'asc']],
        dom: 'lrtip'
      });

      // Plots
      const plots = results.plots || {};
      const plotsGrid = document.getElementById('plots-grid');
      if (Object.keys(plots).length === 0) {
        plotsGrid.textContent = 'No plots found. Ensure plots are generated and stored in data/plots.';
      } else {
        Object.entries(plots).forEach(([name, path]) => {
          const card = document.createElement('div');
          card.className = 'card';
          const img = document.createElement('img');
          img.src = path.startsWith('http') ? path : (path.startsWith('./') ? path : './' + path.replace(/^\.?\//,''));
          img.alt = name;
          img.style.maxWidth = '100%';
          img.style.display = 'block';
          const caption = document.createElement('div');
          caption.style.marginTop = '6px';
          caption.textContent = name;
          card.appendChild(img);
          card.appendChild(caption);
          plotsGrid.appendChild(card);
        });
      }
    }

    loadAll().catch(err => {
      console.error(err);
      document.getElementById('metrics-body').textContent = 'Failed to load JSON files. Ensure index.html sits beside the output JSONs.';
    });
  </script>
</body>
</html>
